name: GitHub Release
run-name: ${{ github.actor }} is creating a GitHub release ðŸš€

on:
  push:
    branches: [ gh-release ]

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[skip release]')"
    permissions:
      contents: write
      issues: write
      pull-requests: write
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for changelog generation
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Set the origin remote to GitHub for this workflow
          git remote set-url origin https://github.com/LiamHardman/fm-dash.git
          
          # Remove any other remotes to avoid confusion
          git remote remove gitea 2>/dev/null || true

      - name: Install semantic-release locally (preserving existing package.json)
        run: |
          # Install semantic-release packages locally without modifying existing package.json
          npm install --save-dev --legacy-peer-deps semantic-release@^24.2.5 @semantic-release/changelog@^6.0.3 @semantic-release/git@^10.0.1 @semantic-release/github@^10.0.7 conventional-changelog-conventionalcommits@^8.0.0

      - name: Verify installed packages
        run: |
          echo "ðŸ” Installed semantic-release packages:"
          npm list --depth=0 | grep semantic-release || echo "No semantic-release packages found"
          echo ""
          echo "ðŸ” Checking for Gitea plugin:"
          npm list @saithodev/semantic-release-gitea 2>/dev/null || echo "âœ… Gitea plugin not installed"

      - name: Verify Git configuration and clean up
        run: |
          echo "ðŸ” Git remotes:"
          git remote -v
          echo ""
          echo "ðŸ” Current repository URL:"
          git config --get remote.origin.url
          echo ""
          echo "ðŸ” Current working directory:"
          pwd
          echo ""
          echo "ðŸ” Backing up original package.json and removing semantic-release config:"
          cp package.json package.json.backup
          
          # Remove the "release" section from package.json using jq
          if command -v jq >/dev/null 2>&1; then
            jq 'del(.release)' package.json > package.json.tmp && mv package.json.tmp package.json
            echo "âœ… Removed release configuration from package.json"
          else
            echo "âš ï¸ jq not available, will rely on .releaserc.json to override"
          fi
          
          echo "ðŸ” Removing any existing semantic-release config files:"
          rm -f .releaserc .releaserc.js .releaserc.yaml .releaserc.yml
          rm -f release.config.js release.config.json
          echo "âœ… Cleanup complete"

      - name: Create GitHub release config
        run: |
          cat > .releaserc.json << 'EOF'
          {
            "branches": [
              "gh-release"
            ],
            "repositoryUrl": "https://github.com/LiamHardman/fm-dash.git",
            "plugins": [
              "@semantic-release/commit-analyzer",
              "@semantic-release/release-notes-generator",
              "@semantic-release/changelog",
              [
                "@semantic-release/npm",
                {
                  "npmPublish": false
                }
              ],
              [
                "@semantic-release/git",
                {
                  "assets": ["package.json", "package-lock.json", "CHANGELOG.md"],
                  "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
                }
              ],
@semantic-release/github
            ]
          }
          EOF
          
          echo "ðŸ” Verifying .releaserc.json was created correctly:"
          cat .releaserc.json



      - name: Build application
        run: |
          echo "ðŸ—ï¸ Building application for release..."
          npm run build

      - name: Run tests
        run: |
          echo "ðŸ§ª Running tests before release..."
          npm run test:optional
          npm run test:go:timeout

      - name: Run semantic-release (dry-run) - GitHub
        run: |
          echo "ðŸ” Analyzing commits for GitHub release..."
          ./node_modules/.bin/semantic-release --dry-run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0

      - name: Create GitHub release
        run: |
          echo "ðŸš€ Creating GitHub release..."
          ./node_modules/.bin/semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0

      - name: Restore original package.json
        if: always()
        run: |
          if [ -f package.json.backup ]; then
            mv package.json.backup package.json
            echo "âœ… Restored original package.json"
          fi

      - name: GitHub release summary
        if: always()
        run: |
          echo "ðŸ“‹ GitHub Release Pipeline Summary"
          echo "================================="
          echo ""
          echo "âœ… Conventional commit analysis completed"
          echo "ðŸ“¦ Package version updated (if applicable)"
          echo "ðŸ“ Changelog generated/updated"
          echo "ðŸ·ï¸ Git tag created (if new version)"
          echo "ðŸ“‹ GitHub release created (if new version)"
          echo ""
          echo "â„¹ï¸  Commit format guide:"
          echo "   feat: new feature (minor version bump)"
          echo "   fix: bug fix (patch version bump)"
          echo "   feat!: breaking change (major version bump)"
          echo "   docs: documentation changes (no version bump)"
          echo "   chore: maintenance tasks (no version bump)"
          echo ""
          echo "ðŸš« To skip release: Add '[skip release]' to commit message"
          echo ""
          echo "ðŸ“ Note: This workflow only creates GitHub releases"
          echo "ðŸ”— Repository: https://github.com/LiamHardman/fm-dash" 