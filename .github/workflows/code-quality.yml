name: Code Quality Checks
run-name: ${{ github.actor }} is running code quality checks ğŸ”

on:
  push:
    branches: [ gh-release, develop ]
  pull_request:
    branches: [ gh-release, develop ]

jobs:
  frontend-linting:
    name: Frontend Code Quality (Biome)
    runs-on: ubuntu-latest
    continue-on-error: true # Don't fail the pipeline if linting fails
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Biome linting check
        run: |
          echo "ğŸ” Running Biome linting and formatting checks..."
          npm run lint:check || echo "âš ï¸ Biome found linting/formatting issues"

      - name: Run Biome formatting check
        run: |
          echo "ğŸ¨ Checking code formatting with Biome..."
          npm run format:check || echo "âš ï¸ Biome found formatting issues"

      - name: Frontend linting summary
        if: always()
        run: |
          echo "ğŸ“‹ Frontend Code Quality Summary:"
          echo "================================="
          echo "âœ… Biome linting and formatting checks completed"
          echo "ğŸ’¡ To fix issues locally, run: npm run fix"

  backend-linting:
    name: Backend Code Quality (Go)
    runs-on: ubuntu-latest
    continue-on-error: true # Don't fail the pipeline if linting fails
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.3'
          cache-dependency-path: go.sum

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.54.2
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Run Go linting
        working-directory: ./src/api
        run: |
          echo "ğŸ” Running golangci-lint checks..."
          golangci-lint run || echo "âš ï¸ golangci-lint found issues"

      - name: Run Go unit tests
        working-directory: ./test/api
        run: |
          echo "ğŸ§ª Running Go unit tests..."
          go test -v ./... || echo "âš ï¸ Some Go tests failed"

      - name: Generate test coverage report
        working-directory: ./test/api
        run: |
          echo "ğŸ“Š Generating test coverage report..."
          go test -coverprofile=coverage.out ./... || echo "âš ï¸ Coverage generation failed"
          if [ -f coverage.out ]; then
            go tool cover -html=coverage.out -o coverage.html || echo "âš ï¸ HTML coverage report generation failed"
            go tool cover -func=coverage.out || echo "âš ï¸ Coverage summary failed"
          fi

      - name: Upload coverage reports to Codecov
        if: success()
        uses: codecov/codecov-action@v4
        with:
          files: ./test/api/coverage.out
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: Backend linting summary
        if: always()
        run: |
          echo "ğŸ“‹ Backend Code Quality Summary:"
          echo "==============================="
          echo "âœ… Go linting and testing checks completed"
          echo "ğŸ§ª Unit tests help ensure code reliability"
          echo "ğŸ“Š Coverage reports help identify untested code"
          echo "ğŸ’¡ To fix issues locally, run: npm run lint:go:fix"
          echo "ğŸ”§ To run tests locally, run: cd test/api && go test -v ./..."

  code-quality-summary:
    name: Code Quality Summary
    runs-on: ubuntu-latest
    needs: [frontend-linting, backend-linting]
    if: always()
    
    steps:
      - name: Overall summary
        run: |
          echo "ğŸ¯ Code Quality Pipeline Summary"
          echo "==============================="
          echo ""
          echo "Frontend (Biome): ${{ needs.frontend-linting.result }}"
          echo "Backend (Go): ${{ needs.backend-linting.result }}"
          echo ""
          echo "ğŸ“ Note: Code quality checks are informational only"
          echo "ğŸš€ Deployment pipeline runs independently"
          echo ""
          echo "ğŸ› ï¸  Local development commands:"
          echo "   npm run check     - Run all checks"
          echo "   npm run fix       - Fix auto-fixable issues"
          echo "   npm run lint:go   - Check Go code" 